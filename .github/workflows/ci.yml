name: CI

on:
  push:
    branches-ignore:
      - "release/**"
  pull_request:
    branches-ignore:
      - "release/**"

jobs:
  test:
    name: Backend & frontend tests (make test)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.24"

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            web/node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('web/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Run make test (Go tests + web build)
        run: make test

  sync-release-branch:
    name: Sync release/YYYYMMDD after successful tests
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && needs.test.result == 'success'
    permissions:
      contents: write
    steps:
      - name: Create or update release/YYYYMMDD branch
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.sha;

            // Use UTC date as version, format: YYYYMMDD
            const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const releaseRef = `heads/release/${today}`;

            core.info(`Syncing ${releaseRef} to commit ${sha}`);

            try {
              // Try to get existing release/YYYYMMDD ref
              await github.rest.git.getRef({
                owner,
                repo,
                ref: releaseRef,
              });

              // Update existing ref to point at current commit
              await github.rest.git.updateRef({
                owner,
                repo,
                ref: releaseRef,
                sha,
                force: true,
              });

              core.info(`Updated release/${today} to ${sha}`);
            } catch (error) {
              if (error.status === 404) {
                // Ref does not exist yet, create it
                await github.rest.git.createRef({
                  owner,
                  repo,
                  ref: `refs/${releaseRef}`,
                  sha,
                });
                core.info(`Created release/${today} at ${sha}`);
              } else {
                core.setFailed(`Failed to sync release branch: ${error.message}`);
                throw error;
              }
            }
